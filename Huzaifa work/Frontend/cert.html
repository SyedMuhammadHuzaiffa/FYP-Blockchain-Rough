<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CertChain • Certificate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="./index.html">CertChain</a>
        </div>
    </nav>

    <main class="container py-4" id="content">
        <div class="alert alert-light border d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
            Loading certificate…
        </div>
    </main>

    <!-- Order matters: config -> data -> api -> utils -->
    <script src="./scripts/config.js"></script>
    <script src="./scripts/data.js"></script>
    <script src="./scripts/api.js"></script>
    <script src="./scripts/utils.js"></script>

    <script>
        (async function () {
            const el = document.getElementById('content');

            function badgeClass(status) {
                if (status === 'valid') return 'success';
                if (status === 'revoked') return 'danger';
                return 'secondary';
            }

            function txUrlFrom(cert) {
                // Prefer explicit URL if present
                if (cert.txUrl) return cert.txUrl;
                // Else derive from txHash + CONFIG explorer
                if (cert.txHash && window.CONFIG && window.CONFIG.CHAIN_EXPLORER_BASE) {
                    return (window.CONFIG.CHAIN_EXPLORER_BASE.replace(/\/+$/, '') + '/' + cert.txHash);
                }
                return '';
            }

            function qrFor(url) {
                // Simple QR without dependencies
                const data = encodeURIComponent(url);
                return `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${data}`;
            }

            // Read id from ?id=… (fallback: try last segment)
            const params = new URLSearchParams(location.search);
            let id = params.get('id');
            if (!id) {
                const parts = location.pathname.split('/').filter(Boolean);
                id = parts[parts.length - 1] || '';
            }
            if (!id) {
                el.innerHTML = `<div class="alert alert-warning">No certificate id provided. Go to <a href="./verify.html">Verify</a>.</div>`;
                return;
            }

            try {
                const cert = await Promise.resolve(window.API.getCertificate(id));
                if (!cert) {
                    el.innerHTML = `
        <div class="alert alert-warning">
          Certificate <strong>${id}</strong> not found. Try <a href="./verify.html">Verify</a>.
        </div>`;
                    return;
                }

                const txUrl = txUrlFrom(cert);
                const pageUrl = `${location.origin}${location.pathname}?id=${encodeURIComponent(cert.id)}`;

                el.innerHTML = `
      <div class="card p-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3 mb-3">
          <div>
            <h2 class="mb-1">${cert.program || 'Certificate'}</h2>
            <p class="text-secondary mb-0">
              Issued to <strong>${cert.holder || '—'}</strong>
              ${cert.issuedAt ? ' on ' + UI.fmtDate(cert.issuedAt) : ''}
            </p>
          </div>
          <span class="badge text-bg-${badgeClass(cert.status)} text-uppercase">${cert.status || 'unknown'}</span>
        </div>

        <div class="row g-4">
          <div class="col-lg-7">
            <dl class="row mb-0">
              <dt class="col-sm-4">Certificate ID</dt>
              <dd class="col-sm-8">${cert.id}</dd>

              <dt class="col-sm-4">Hash</dt>
              <dd class="col-sm-8"><code>${cert.hash || '—'}</code></dd>

              <dt class="col-sm-4">On-chain Tx</dt>
              <dd class="col-sm-8">
                ${txUrl ? `<a href="${txUrl}" target="_blank" rel="noopener">Open transaction</a>` : '—'}
              </dd>

              ${cert.status === 'revoked' && cert.revokeReason ? `
              <dt class="col-sm-4">Revocation Reason</dt>
              <dd class="col-sm-8 text-danger">${cert.revokeReason}</dd>` : ''}
            </dl>

            <div class="d-flex flex-wrap gap-2 mt-4">
              <button id="copy" class="btn btn-outline-secondary btn-sm" type="button">Copy Link</button>
              <button id="share" class="btn btn-outline-secondary btn-sm" type="button">Share</button>
              <button id="print" class="btn btn-outline-secondary btn-sm" type="button">Print</button>
            </div>
          </div>

          <div class="col-lg-5">
            <h6>Share &amp; Verify via QR</h6>
            <p class="text-secondary small mb-2">Scan to open this certificate page.</p>
            <img class="border rounded p-2" alt="QR Code" src="${qrFor(pageUrl)}" />
            <div class="small text-secondary mt-2">
              URL: <a href="${pageUrl}">${pageUrl}</a>
            </div>
          </div>
        </div>
      </div>
    `;

                // Actions
                document.getElementById('copy').addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(pageUrl);
                        alert('Link copied!');
                    } catch {
                        // Fallback
                        prompt('Copy this link:', pageUrl);
                    }
                });

                document.getElementById('share').addEventListener('click', async () => {
                    if (navigator.share) {
                        try { await navigator.share({ title: 'Certificate ' + cert.id, url: pageUrl }); } catch { }
                    } else {
                        prompt('Share this link:', pageUrl);
                    }
                });

                document.getElementById('print').addEventListener('click', () => window.print());

            } catch (err) {
                el.innerHTML = `<div class="alert alert-danger">Failed to load certificate. Please try again.</div>`;
            }
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>